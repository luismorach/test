{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, ViewChild } from '@angular/core';\nimport { FormControl } from '@angular/forms';\nimport { DinamicInput } from 'src/app/utils/DinamicInput';\nlet DetallesVentaComponent = class DetallesVentaComponent extends DinamicInput {\n  constructor(routes, comunicatorSvc, renderer, route, ventasSvc, usuariosSvc, productosSvc, fb, location, devolucionesSvc) {\n    super();\n    this.routes = routes;\n    this.comunicatorSvc = comunicatorSvc;\n    this.renderer = renderer;\n    this.route = route;\n    this.ventasSvc = ventasSvc;\n    this.usuariosSvc = usuariosSvc;\n    this.productosSvc = productosSvc;\n    this.fb = fb;\n    this.location = location;\n    this.devolucionesSvc = devolucionesSvc;\n    this.title = [];\n    this.user_pay = [];\n    this.registers_pay = [];\n    this.sell_products = [];\n    this.repayments = [];\n    this.products = [];\n    this.pays = [];\n  }\n  ngOnInit() {\n    setTimeout(() => {\n      /* Obtengo la ruta actual y la transformo para obtener el titulo del componente*/\n      this.ruta = this.routes.url.slice(this.routes.url.slice(1).indexOf('/') + 2, this.routes.url.lastIndexOf('?'));\n      this.title.push(\"fas fa-coins fa-fw\"); //aañado el icono del titulo al array\n      this.title.push(decodeURI(this.ruta).toUpperCase()); //añado el titulo al array\n      this.comunicatorSvc.setTitleComponent(this.title);\n    });\n    this.route.queryParams.subscribe(params => {\n      this.ventasSvc.getSell(params['id_sell']).subscribe(res => {\n        let aux = res;\n        this.sell = aux[0];\n        this.user_sell = aux[0];\n        this.client = aux[0];\n        this.register_sell = aux[0];\n        console.log(res);\n      });\n      this.ventasSvc.getProductsSell(params['id_sell']).subscribe(res => {\n        if (res instanceof Array) {\n          let aux = res;\n          this.products = aux;\n          this.sell_products = aux;\n        }\n      });\n      this.ventasSvc.getPaysSell(params['id_sell']).subscribe(res => {\n        console.log(res);\n        if (res instanceof Array) {\n          let aux = res;\n          this.user_pay = aux;\n          this.registers_pay = aux;\n          this.pays = aux;\n        }\n      });\n    });\n    this.formDevolucion = this.fb.group({\n      quantity_back: new FormControl('')\n    });\n  }\n  showModal(product, index) {\n    this.indexElementToBack = index;\n    this.renderer.setProperty(this.quantityBack?.nativeElement.children[0].children[0], 'textContent', 'Realizar Devolución (' + product.name + ' ' + product.mark + ' ' + product.model + ')');\n    this.quantityBack?.nativeElement.showModal();\n  }\n  calcularPromedio(price) {\n    return (this.products[this.indexElementToBack].sell_price * this.products[this.indexElementToBack].exist_quantity - this.sell_products[this.indexElementToBack].sell_price * Number(this.formDevolucion.get('quantity_back')?.value)) / (this.products[this.indexElementToBack].exist_quantity - Number(this.formDevolucion.get('quantity_back')?.value));\n  }\n  registrarDevolucion() {\n    let content = '';\n    if (Number(this.formDevolucion.get('quantity_back')?.value) > this.sell_products[this.indexElementToBack].quantity_products - this.sell_products[this.indexElementToBack].quantity_back) {\n      content = 'La cantidad a devolver es mayor a la registrada en la compra';\n    } else if (this.products[this.indexElementToBack].exist_quantity - Number(this.formDevolucion.get('quantity_back')?.value) < 0) {\n      content = 'No existe esa cantidad en el almacen, los productos ya han sido vendidos';\n    } else {\n      let repayment = {\n        type: 'compra',\n        date: new Date(),\n        id_operation: this.sell_products[this.indexElementToBack].id_sell,\n        quantity: Number(this.formDevolucion.get('quantity_back')?.value),\n        price: this.sell_products[this.indexElementToBack].sell_price,\n        total: Number(this.formDevolucion.get('quantity_back')?.value) * this.sell_products[this.indexElementToBack].sell_price,\n        coin: this.sell.coin,\n        exist_quantity: this.products[this.indexElementToBack].exist_quantity - Number(this.formDevolucion.get('quantity_back')?.value),\n        weighted_averages: Number(((this.products[this.indexElementToBack].sell_price * this.products[this.indexElementToBack].exist_quantity - this.comunicatorSvc.converterToMainCoin(this.sell_products[this.indexElementToBack].sell_price, this.sell.exchange) * Number(this.formDevolucion.get('quantity_back')?.value)) / (this.products[this.indexElementToBack].exist_quantity - Number(this.formDevolucion.get('quantity_back')?.value))).toFixed(2)),\n        id_user: this.sell.id_user,\n        id_product: this.sell_products[this.indexElementToBack].id_product\n      };\n      repayment.weighted_averages = isNaN(repayment.weighted_averages) ? 0 : repayment.weighted_averages;\n      repayment.weighted_averages = this.comunicatorSvc.converterToSecondaryCoin(repayment.weighted_averages, this.sell.exchange);\n      this.devolucionesSvc.setRepayment(repayment).subscribe(res => {\n        if (res.title.includes('Registrada')) {\n          this.repayments.push(repayment);\n          this.sell_products[this.indexElementToBack].quantity_back += Number(this.formDevolucion.get('quantity_back')?.value);\n          this.sell.total_sell -= Number(this.formDevolucion.get('quantity_back')?.value) * this.sell_products[this.indexElementToBack].sell_price;\n          this.products[this.indexElementToBack].sell_price = this.comunicatorSvc.converterToMainCoin(repayment.weighted_averages, this.sell.exchange);\n          this.products[this.indexElementToBack].sell_price = Number(((this.products[this.indexElementToBack].sell_price * this.products[this.indexElementToBack].exist_quantity - this.comunicatorSvc.converterToMainCoin(this.sell_products[this.indexElementToBack].sell_price, this.sell.exchange) * Number(this.formDevolucion.get('quantity_back')?.value)) / (this.products[this.indexElementToBack].exist_quantity - Number(this.formDevolucion.get('quantity_back')?.value))).toFixed(2));\n          this.products[this.indexElementToBack].exist_quantity = repayment.exist_quantity;\n          console.log(this.products[this.indexElementToBack].sell_price);\n          this.products[this.indexElementToBack].sell_price = this.products[this.indexElementToBack].exist_quantity === 0 ? 0 : this.products[this.indexElementToBack].sell_price;\n          this.ventasSvc.updateSell(this.sell_products[this.indexElementToBack].id_sell, this.sell).subscribe(res => console.log(res));\n          this.ventasSvc.updateProductsSell(this.sell_products[this.indexElementToBack].id_sell, this.sell_products[this.indexElementToBack].id_product, this.sell_products[this.indexElementToBack]).subscribe(res => console.log(res));\n          this.productosSvc.updateProducto(this.products[this.indexElementToBack].id_product, this.products[this.indexElementToBack]).subscribe(res => console.log(res));\n        }\n        console.log(res);\n        this.changeModal(res);\n        this.popUp?.nativeElement.showModal();\n      });\n    }\n    if (content !== '') {\n      let values = {\n        icon: 'fa-regular fa-circle-xmark',\n        title: 'Ocurrió un error inesperado',\n        content: content\n      };\n      this.changeModal(values);\n      this.popUp?.nativeElement.showModal();\n    }\n  }\n  calcularSubtotal(index) {\n    let price = this.products[index].sell_price;\n    let discount = this.products[index].discount;\n    let quantity = this.sell_products[index].quantity_products;\n    return Number((price * quantity - Number((price * discount).toFixed(2)) * quantity).toFixed(2));\n  }\n  calcularTotal() {\n    let total = 0;\n    this.products.forEach((product, index) => {\n      total += this.calcularSubtotal(index);\n    });\n    return total;\n  }\n  calcularDescuentoVenta() {\n    return Number((this.sell.discount * this.calcularTotal()).toFixed(2));\n  }\n  calcularImpuestoVenta() {\n    let montoImponible = 0;\n    this.products.forEach((product, index) => {\n      if (product.impuest > 0) {\n        montoImponible += Number((product.impuest * this.calcularSubtotal(index)).toFixed(2));\n      }\n    });\n    return montoImponible;\n  }\n  calcularCostosVenta() {\n    let total = 0;\n    this.products.forEach((product, index) => {\n      total += product.buy_price * this.sell_products[index].quantity_products;\n    });\n    return total;\n  }\n  total() {\n    return Number((this.calcularTotal() + this.calcularImpuestoVenta() - this.calcularDescuentoVenta()).toFixed(2));\n  }\n  redirectToVentasRealizadas() {\n    this.location.back();\n  }\n  product(repayment) {\n    let name_product = '';\n    this.products.forEach(product => {\n      if (product.id_product === repayment.id_product) {\n        name_product = product.name + ' ' + product.mark + ' ' + product.model;\n      }\n    });\n    return name_product;\n  }\n  acept() {\n    if (this.popUp?.nativeElement.children[1].textContent === 'Ocurrió un error inesperado') {\n      this.cancel(this.popUp);\n    } else {\n      this.cancel(this.popUp);\n      this.cancel(this.quantityBack);\n    }\n  }\n};\n__decorate([ViewChild('quantity', {\n  static: true\n})], DetallesVentaComponent.prototype, \"quantityBack\", void 0);\n__decorate([ViewChild('popup', {\n  static: true\n})], DetallesVentaComponent.prototype, \"popUp\", void 0);\nDetallesVentaComponent = __decorate([Component({\n  selector: 'app-detalles-venta',\n  templateUrl: './detalles-venta.component.html',\n  styleUrls: ['./detalles-venta.component.css']\n})], DetallesVentaComponent);\nexport { DetallesVentaComponent };","map":{"version":3,"mappings":"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","names":["Component","ViewChild","FormControl","DinamicInput","DetallesVentaComponent","constructor","routes","comunicatorSvc","renderer","route","ventasSvc","usuariosSvc","productosSvc","fb","location","devolucionesSvc","ngOnInit","setTimeout","ruta","url","slice","indexOf","lastIndexOf","title","push","decodeURI","toUpperCase","setTitleComponent","queryParams","subscribe","params","getSell","res","aux","sell","user_sell","client","register_sell","console","log","getProductsSell","Array","products","sell_products","getPaysSell","user_pay","registers_pay","pays","formDevolucion","group","quantity_back","showModal","product","index","indexElementToBack","setProperty","quantityBack","nativeElement","children","name","mark","model","calcularPromedio","price","sell_price","exist_quantity","Number","get","value","registrarDevolucion","content","quantity_products","repayment","type","date","Date","id_operation","id_sell","quantity","total","coin","weighted_averages","converterToMainCoin","exchange","toFixed","id_user","id_product","isNaN","converterToSecondaryCoin","setRepayment","includes","repayments","total_sell","updateSell","updateProductsSell","updateProducto","changeModal","popUp","values","icon","calcularSubtotal","discount","calcularTotal","forEach","calcularDescuentoVenta","calcularImpuestoVenta","montoImponible","impuest","calcularCostosVenta","buy_price","redirectToVentasRealizadas","back","name_product","acept","textContent","cancel","__decorate","static","selector","templateUrl","styleUrls"],"sourceRoot":"","sources":["/home/luis/Documentos/systems vs code/inventary-system/client/src/app/content/ventas/detalles-venta/detalles-venta.component.ts"],"sourcesContent":["import { Component, ElementRef, Renderer2, ViewChild } from '@angular/core';\nimport { FormBuilder, FormControl, FormGroup } from '@angular/forms';\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { product, repayment, sell, sell_product, user, alert, pay, register, client } from 'src/app/interfaces/interfaces';\nimport { ComunicatorComponetsService } from 'src/app/services/comunicator/comunicator-componets.service';\nimport { DinamicInput } from 'src/app/utils/DinamicInput';\nimport { VentasService } from '../../ventas/service/ventas.service';\nimport { UsuariosService } from '../../administracion/usuarios/service/usuarios.service';\nimport { ProductosService } from '../../productos/productos-en-almacen/service/productos.service';\nimport { DevolucionesService } from '../../devoluciones/service/devoluciones.service';\nimport { Location } from '@angular/common';\n\n@Component({\n  selector: 'app-detalles-venta',\n  templateUrl: './detalles-venta.component.html',\n  styleUrls: ['./detalles-venta.component.css']\n})\nexport class DetallesVentaComponent extends DinamicInput {\n\n  ruta!: string\n  title: string[] = []\n  sell!: sell\n  user_sell!: user\n  user_pay: user[]=[]\n  client!:client\n  register_sell!:register\n  registers_pay:register[]=[]\n  sell_products: sell_product[] = []\n  repayments: repayment[] = []\n  products: product[] = []\n  pays:pay[]=[]\n  indexElementToBack!: number\n  formDevolucion!: FormGroup\n  @ViewChild('quantity', { static: true }) quantityBack?: ElementRef;\n  @ViewChild('popup', { static: true }) override popUp?: ElementRef;\n\n  constructor(private routes: Router,\n    private comunicatorSvc: ComunicatorComponetsService,\n    public override renderer: Renderer2,\n    private route: ActivatedRoute,\n    private ventasSvc: VentasService,\n    private usuariosSvc: UsuariosService,\n    private productosSvc: ProductosService,\n    private fb: FormBuilder,\n    private location: Location,\n    private devolucionesSvc: DevolucionesService) {\n    super()\n  }\n\n  ngOnInit() {\n    setTimeout(() => {\n      /* Obtengo la ruta actual y la transformo para obtener el titulo del componente*/\n      this.ruta = this.routes.url.slice((this.routes.url.slice(1).indexOf('/')) + 2, this.routes.url.lastIndexOf('?'));\n      this.title.push(\"fas fa-coins fa-fw\");//aañado el icono del titulo al array\n      this.title.push(decodeURI(this.ruta).toUpperCase());//añado el titulo al array\n      this.comunicatorSvc.setTitleComponent(this.title);\n    });\n    this.route.queryParams.subscribe((params) => {\n      this.ventasSvc.getSell(params['id_sell']).subscribe(res => {\n        let aux: any = res\n        this.sell = aux[0]\n        this.user_sell=aux[0]\n        this.client=aux[0]\n        this.register_sell=aux[0]\n        console.log(res)\n      })\n      this.ventasSvc.getProductsSell(params['id_sell']).subscribe(res => {\n        if (res instanceof Array){\n          let aux:any=res\n          this.products=aux\n          this.sell_products = aux\n        }\n      })\n      this.ventasSvc.getPaysSell(params['id_sell']).subscribe(res=>{\n        console.log(res)\n        if(res instanceof Array){\n          let aux:any=res\n          this.user_pay=aux\n          this.registers_pay=aux\n          this.pays=aux\n        }\n      })\n    })\n    this.formDevolucion = this.fb.group({\n      quantity_back: new FormControl('')\n    })\n  }\n  showModal(product: product, index: number) {\n    this.indexElementToBack = index\n    this.renderer.setProperty(this.quantityBack?.nativeElement.children[0].children[0],\n      'textContent', 'Realizar Devolución (' + product.name + ' ' + product.mark + ' ' + product.model + ')')\n    this.quantityBack?.nativeElement.showModal()\n  }\n  calcularPromedio(price: number) {\n    return ((this.products[this.indexElementToBack].sell_price *\n      this.products[this.indexElementToBack].exist_quantity) -\n      (this.sell_products[this.indexElementToBack].sell_price *\n        Number(this.formDevolucion.get('quantity_back')?.value))) /\n      (this.products[this.indexElementToBack].exist_quantity -\n        Number(this.formDevolucion.get('quantity_back')?.value))\n  }\n  registrarDevolucion() {\n    let content = ''\n    if (Number(this.formDevolucion.get('quantity_back')?.value) >\n      (this.sell_products[this.indexElementToBack].quantity_products -\n        this.sell_products[this.indexElementToBack].quantity_back)) {\n      content = 'La cantidad a devolver es mayor a la registrada en la compra'\n    } else if ((this.products[this.indexElementToBack].exist_quantity -\n      Number(this.formDevolucion.get('quantity_back')?.value)) < 0) {\n      content = 'No existe esa cantidad en el almacen, los productos ya han sido vendidos'\n    } else {\n      let repayment: repayment = {\n        type: 'compra',\n        date: new Date(),\n        id_operation: this.sell_products[this.indexElementToBack].id_sell,\n        quantity: Number(this.formDevolucion.get('quantity_back')?.value),\n        price: this.sell_products[this.indexElementToBack].sell_price,\n        total: Number(this.formDevolucion.get('quantity_back')?.value) *\n          this.sell_products[this.indexElementToBack].sell_price,\n        coin: this.sell.coin,\n        exist_quantity: this.products[this.indexElementToBack].exist_quantity - Number(this.formDevolucion.get('quantity_back')?.value),\n        weighted_averages: Number((((this.products[this.indexElementToBack].sell_price *\n          this.products[this.indexElementToBack].exist_quantity) -\n          (this.comunicatorSvc.converterToMainCoin(this.sell_products[this.indexElementToBack].sell_price, this.sell.exchange) *\n            Number(this.formDevolucion.get('quantity_back')?.value))) /\n          (this.products[this.indexElementToBack].exist_quantity -\n            Number(this.formDevolucion.get('quantity_back')?.value))).toFixed(2)),\n        id_user: this.sell.id_user,\n        id_product: this.sell_products[this.indexElementToBack].id_product,\n      }\n      repayment.weighted_averages = (isNaN(repayment.weighted_averages)) ? 0 : repayment.weighted_averages\n      repayment.weighted_averages = this.comunicatorSvc.converterToSecondaryCoin(repayment.weighted_averages, this.sell.exchange)\n      this.devolucionesSvc.setRepayment(repayment).subscribe(res => {\n        if (res.title.includes('Registrada')) {\n          this.repayments.push(repayment)\n          this.sell_products[this.indexElementToBack].quantity_back += Number(this.formDevolucion.get('quantity_back')?.value)\n          this.sell.total_sell -= (Number(this.formDevolucion.get('quantity_back')?.value) *\n            this.sell_products[this.indexElementToBack].sell_price)\n          this.products[this.indexElementToBack].sell_price = this.comunicatorSvc.converterToMainCoin(\n            repayment.weighted_averages, this.sell.exchange)\n\n          this.products[this.indexElementToBack].sell_price =\n            Number((((this.products[this.indexElementToBack].sell_price *\n              this.products[this.indexElementToBack].exist_quantity) -\n              (this.comunicatorSvc.converterToMainCoin(this.sell_products[this.indexElementToBack].sell_price, this.sell.exchange) *\n                Number(this.formDevolucion.get('quantity_back')?.value))) /\n              (this.products[this.indexElementToBack].exist_quantity -\n                Number(this.formDevolucion.get('quantity_back')?.value))).toFixed(2))\n          this.products[this.indexElementToBack].exist_quantity = repayment.exist_quantity\n          console.log(this.products[this.indexElementToBack].sell_price)\n          this.products[this.indexElementToBack].sell_price = (\n            this.products[this.indexElementToBack].exist_quantity === 0) ? 0 : this.products[this.indexElementToBack].sell_price\n          this.ventasSvc.updateSell(this.sell_products[this.indexElementToBack].id_sell, this.sell).subscribe(\n            res => console.log(res)\n          )\n          this.ventasSvc.updateProductsSell(this.sell_products[this.indexElementToBack].id_sell,\n            this.sell_products[this.indexElementToBack].id_product, this.sell_products[this.indexElementToBack]).subscribe(\n              res => console.log(res)\n            )\n          this.productosSvc.updateProducto(this.products[this.indexElementToBack].id_product,\n            this.products[this.indexElementToBack]).subscribe(res => console.log(res))\n        }\n        console.log(res)\n        this.changeModal(res)\n        this.popUp?.nativeElement.showModal()\n      })\n    }\n    if (content !== '') {\n      let values: alert = {\n        icon: 'fa-regular fa-circle-xmark',\n        title: 'Ocurrió un error inesperado',\n        content: content\n      }\n      this.changeModal(values)\n      this.popUp?.nativeElement.showModal()\n    }\n  }\n\n  calcularSubtotal(index: number) {\n    let price = this.products[index].sell_price\n    let discount = this.products[index].discount\n    let quantity = this.sell_products[index].quantity_products\n    return Number(((price * quantity) - (Number((price * discount).toFixed(2)) * quantity)).toFixed(2))\n  }\n\n  calcularTotal() {\n    let total = 0\n    this.products.forEach((product: product, index: number) => {\n      total += this.calcularSubtotal(index)\n    });\n    return total\n  }\n  calcularDescuentoVenta() {\n    return Number((this.sell.discount * this.calcularTotal()).toFixed(2))\n  }\n  calcularImpuestoVenta() {\n    let montoImponible = 0\n    this.products.forEach((product: product, index: number) => {\n      if (product.impuest > 0) {\n        montoImponible += Number((product.impuest * this.calcularSubtotal(index)).toFixed(2))\n      }\n    })\n    return montoImponible\n  }\n  calcularCostosVenta(){\n    let total = 0\n    this.products.forEach((product: product, index: number) => {\n      total += product.buy_price*this.sell_products[index].quantity_products\n    });\n    return total\n  }\n  total() {\n    return Number((this.calcularTotal() + this.calcularImpuestoVenta() - this.calcularDescuentoVenta()).toFixed(2))\n  }\n  redirectToVentasRealizadas() {\n    this.location.back()\n  }\n  product(repayment: repayment) {\n    let name_product = ''\n    this.products.forEach((product: product) => {\n      if (product.id_product === repayment.id_product) {\n        name_product = product.name + ' ' + product.mark + ' ' + product.model\n      }\n    })\n    return name_product\n  }\n  acept() {\n    if (this.popUp?.nativeElement.children[1].textContent === 'Ocurrió un error inesperado') {\n      this.cancel(this.popUp)\n    } else {\n      this.cancel(this.popUp)\n      this.cancel(this.quantityBack)\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}