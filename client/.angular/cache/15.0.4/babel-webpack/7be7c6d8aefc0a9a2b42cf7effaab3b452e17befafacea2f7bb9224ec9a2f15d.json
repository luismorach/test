{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, ViewChild } from '@angular/core';\nimport { FormControl, FormGroup, Validators } from '@angular/forms';\nimport { DinamicInput } from 'src/app/utils/DinamicInput';\nlet NuevaVentaComponent = class NuevaVentaComponent extends DinamicInput {\n  constructor(fb, routes, comunicatorSvc, productsSvc, coinsSvc, renderer, clientesSvc) {\n    super();\n    this.fb = fb;\n    this.routes = routes;\n    this.comunicatorSvc = comunicatorSvc;\n    this.productsSvc = productsSvc;\n    this.coinsSvc = coinsSvc;\n    this.renderer = renderer;\n    this.clientesSvc = clientesSvc;\n    this.products = [];\n    this.date = new Date();\n    this.coins = [];\n    this.clientes = [];\n    this.sellProducts = [];\n    this.listProducts = [];\n    this.indexElementToDelete = 0;\n  }\n  ngOnInit() {\n    let title = [];\n    let ruta;\n    setTimeout(() => {\n      /* Obtengo la ruta actual y la transformo para obtener el titulo del componente*/\n      ruta = this.routes.url.slice(this.routes.url.slice(1).indexOf('/') + 2);\n      title.push(\"fas fa-cart-plus fa-fw\"); //aañado el icono del titulo al array\n      title.push(decodeURI(ruta).toUpperCase()); //añado el titulo al array\n      this.comunicatorSvc.setTitleComponent(title);\n    });\n    this.coinsSvc.getCoins().subscribe({\n      next: res => {\n        this.coins = res;\n        res.forEach(coin => {\n          if (coin.type === 'principal') this.coinSelected = coin;\n        });\n      },\n      complete: () => {\n        this.formNewSell.get('coin')?.setValue(this.coinSelected.symbol);\n      }\n    });\n    this.clientesSvc.getClients().subscribe(clientes => {\n      this.clientes = clientes;\n      clientes.forEach(cliente => {\n        if (cliente.names.includes('Publico')) {\n          this.formNewSell.get('client')?.setValue(cliente.document_number);\n        }\n      });\n    });\n    this.productsSvc.getProductos().subscribe(res => this.listProducts = res);\n    this.formNewSell = this.fb.group({\n      barcode: new FormControl('', [Validators.required, Validators.pattern(/^[0-9]+$/)]),\n      productQuantity: new FormControl('', [Validators.pattern(/^[0-9]+$/)]),\n      client: new FormControl(''),\n      productQuantityBySearch: new FormControl(''),\n      coin: new FormControl(''),\n      date: new FormControl(''),\n      time: new FormControl(''),\n      discount: new FormControl('', [Validators.pattern(/^[0-9]+$/)])\n    });\n    this.tableSearch = new FormGroup({\n      search: new FormControl()\n    });\n  }\n  selectMoneda() {\n    this.coins.forEach(coin => {\n      if (coin.symbol === this.formNewSell.get('coin')?.value) {\n        this.coinSelected = coin;\n      }\n    });\n  }\n  verificarProductoAñadido(product) {\n    let exist = false;\n    this.products.forEach(producto => {\n      if (producto.name === product.name) {\n        exist = true;\n      } else {\n        exist = false;\n      }\n    });\n    return exist;\n  }\n  addQuantity(product) {\n    let values = {\n      icon: 'fa-regular fa-circle-xmark',\n      title: 'Ocurrió un error inesperado',\n      content: ''\n    };\n    if (this.verificarProductoAñadido(product)) {\n      values.content = 'Este producto ya se encuentra agregado a la venta';\n      this.changeModal(values);\n      this.popUp?.nativeElement.showModal();\n    } else if (product.exist_quantity === 0) {\n      values.content = 'No hay existencias de este producto para vender';\n      this.changeModal(values);\n      this.popUp?.nativeElement.showModal();\n    } else {\n      this.quantityProduct?.nativeElement.showModal();\n      this.product = product;\n    }\n  }\n  open() {\n    this.cliente?.nativeElement.showModal();\n  }\n  receiveMessage(client) {\n    this.clientes.push(client);\n    console.log(this.clientes);\n    console.log(client);\n    this.formNewSell.get('client')?.setValue(client.document_number);\n    this.cancel(this.cliente);\n  }\n  addProduct() {\n    let quantity;\n    if (this.formNewSell.get('productQuantity')?.value === '') {\n      quantity = 1;\n    } else {\n      quantity = this.formNewSell.get('productQuantity')?.value;\n    }\n    if (this.formNewSell.get('barcode')?.valid) {\n      this.productsSvc.getProductoByBarcode(this.formNewSell.get('barcode')?.value).subscribe(product => {\n        if (product instanceof Array) {\n          if (!this.verificarProductoAñadido(product[0])) {\n            this.sellProducts.push({\n              id_sell: 0,\n              id_product: product[0].id_product,\n              buy_price: 0,\n              sell_price: 0,\n              discount_product: 0,\n              impuest: 0,\n              quantity_products: quantity,\n              exist_products: 0,\n              quantity_back: 0\n            });\n            this.products.push(product[0]);\n          }\n        } else {\n          this.changeModal(product);\n          this.popUp?.nativeElement.showModal();\n          this.formNewSell.get('barcode')?.setValue('');\n          this.formNewSell.get('productQuantity')?.setValue('');\n        }\n      });\n    }\n  }\n  addProductBySearch(product) {\n    let quantity = this.formNewSell.get('productQuantityBySearch')?.value;\n    this.sellProducts.push({\n      id_sell: 0,\n      id_product: product.id_product,\n      buy_price: 0,\n      sell_price: 0,\n      discount_product: 0,\n      impuest: 0,\n      quantity_products: quantity,\n      exist_products: 0,\n      quantity_back: 0\n    });\n    this.products.push(product);\n    this.cancel(this.quantityProduct);\n    this.cancel(this.search);\n  }\n  acept(index) {\n    if (this.popUp?.nativeElement.children[1].textContent.includes('error')) {\n      this.popUp?.nativeElement.close();\n    } else if (this.popUp?.nativeElement.children[1].textContent.includes('¿Estás seguro?')) {\n      this.delete(index);\n      this.popUp?.nativeElement.close();\n    } else {\n      this.popUp?.nativeElement.close();\n    }\n  }\n  calcularSubtotal(product, index) {\n    return this.products[index].sell_price * this.sellProducts[index].quantity_products - this.products[index].sell_price * this.products[index].discount * this.sellProducts[index].quantity_products;\n  }\n  calcularTotal() {\n    let total = 0;\n    this.products.forEach((product, index) => {\n      total += this.products[index].sell_price * this.sellProducts[index].quantity_products - this.products[index].sell_price * this.products[index].discount * this.sellProducts[index].quantity_products;\n    });\n    return this.comunicatorSvc.converter(total, this.coinSelected);\n  }\n  calcularDescuentoVenta() {\n    return Number(this.formNewSell.get('discount')?.value) / 100 * this.calcularTotal();\n  }\n  calcularImpuestoVenta() {\n    let montoImponible = 0;\n    this.products.forEach((product, index) => {\n      if (product.impuest > 0) {\n        montoImponible += product.impuest * (product.sell_price * this.sellProducts[index].quantity_products - product.sell_price * product.discount * this.sellProducts[index].quantity_products);\n      }\n    });\n    return this.comunicatorSvc.converter(montoImponible, this.coinSelected);\n  }\n  total() {\n    return this.calcularTotal() + this.calcularImpuestoVenta() - this.calcularDescuentoVenta();\n  }\n  searchProduct() {\n    this.search?.nativeElement.showModal();\n  }\n  delete(index) {\n    this.products.splice(this.indexElementToDelete, 1);\n    this.sellProducts.splice(this.indexElementToDelete, 1);\n  }\n  validarVenta() {\n    let result = {\n      isValid: false,\n      msj: 'Agrege productos a la venta'\n    };\n    this.products.forEach((product, index) => {\n      if (this.sellProducts[index].quantity_products === 0) {\n        result = {\n          isValid: false,\n          msj: 'La cantidad a vender del producto ' + product.name + 'no puede ser 0'\n        };\n      } else if (this.sellProducts[index].quantity_products > product.exist_quantity) {\n        result = {\n          isValid: false,\n          msj: 'La cantidad a vender del producto ' + product.name + ' es mayor a la existente'\n        };\n      } else {\n        result = {\n          isValid: true,\n          msj: ''\n        };\n      }\n    });\n    return result;\n  }\n  agregarPago() {\n    this.pago?.nativeElement.showModal();\n  }\n};\n__decorate([ViewChild('popup', {\n  static: true\n})], NuevaVentaComponent.prototype, \"popUp\", void 0);\n__decorate([ViewChild('searchProducts', {\n  static: true\n})], NuevaVentaComponent.prototype, \"search\", void 0);\n__decorate([ViewChild('quantity', {\n  static: true\n})], NuevaVentaComponent.prototype, \"quantityProduct\", void 0);\n__decorate([ViewChild('client', {\n  static: true\n})], NuevaVentaComponent.prototype, \"cliente\", void 0);\n__decorate([ViewChild('pay', {\n  static: true\n})], NuevaVentaComponent.prototype, \"pago\", void 0);\nNuevaVentaComponent = __decorate([Component({\n  selector: 'app-nueva-venta',\n  templateUrl: './nueva-venta.component.html',\n  styleUrls: ['./nueva-venta.component.css']\n})], NuevaVentaComponent);\nexport { NuevaVentaComponent };","map":{"version":3,"mappings":"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","names":["Component","ViewChild","FormControl","FormGroup","Validators","DinamicInput","NuevaVentaComponent","constructor","fb","routes","comunicatorSvc","productsSvc","coinsSvc","renderer","clientesSvc","Date","ngOnInit","title","ruta","setTimeout","url","slice","indexOf","push","decodeURI","toUpperCase","setTitleComponent","getCoins","subscribe","next","res","coins","forEach","coin","type","coinSelected","complete","formNewSell","get","setValue","symbol","getClients","clientes","cliente","names","includes","document_number","getProductos","listProducts","group","barcode","required","pattern","productQuantity","client","productQuantityBySearch","date","time","discount","tableSearch","search","selectMoneda","value","verificarProductoAñadido","product","exist","products","producto","name","addQuantity","values","icon","content","changeModal","popUp","nativeElement","showModal","exist_quantity","quantityProduct","open","receiveMessage","console","log","cancel","addProduct","quantity","valid","getProductoByBarcode","Array","sellProducts","id_sell","id_product","buy_price","sell_price","discount_product","impuest","quantity_products","exist_products","quantity_back","addProductBySearch","acept","index","children","textContent","close","delete","calcularSubtotal","calcularTotal","total","converter","calcularDescuentoVenta","Number","calcularImpuestoVenta","montoImponible","searchProduct","splice","indexElementToDelete","validarVenta","result","isValid","msj","agregarPago","pago","__decorate","static","selector","templateUrl","styleUrls"],"sourceRoot":"","sources":["/home/luis/Documentos/systems vs code/inventary-system/client/src/app/content/ventas/nueva-venta/nueva-venta.component.ts"],"sourcesContent":["import { Component, ElementRef, Renderer2, ViewChild } from '@angular/core';\nimport { FormBuilder, FormControl, FormGroup, Validators } from '@angular/forms';\nimport { Router } from '@angular/router';\nimport { client, coin, product, register, sell, sell_product } from 'src/app/interfaces/interfaces';\nimport { ComunicatorComponetsService } from 'src/app/services/comunicator/comunicator-componets.service';\nimport { DinamicInput } from 'src/app/utils/DinamicInput';\nimport { ProductosService } from '../../productos/productos-en-almacen/service/productos.service';\nimport { CoinsService } from '../../configuraciones/service/coins.service';\nimport { ClientesService } from '../../administracion/clientes/service/clientes.service';\n\n@Component({\n  selector: 'app-nueva-venta',\n  templateUrl: './nueva-venta.component.html',\n  styleUrls: ['./nueva-venta.component.css'],\n})\nexport class NuevaVentaComponent extends DinamicInput{\n  tableSearch!:FormGroup\n  formNewSell!: FormGroup;\n  products: product[] = []\n  date = new Date()\n  coins:coin[]=[]\n  clientes:client[]=[]\n  coinSelected!:coin\n  sell!:sell\n  sellProducts:sell_product[]=[]\n  listProducts:product[]=[]\n  product!:product\n  indexElementToDelete:number=0\n  @ViewChild('popup', { static: true }) override popUp?: ElementRef;\n  @ViewChild('searchProducts', { static: true }) search?: ElementRef;\n  @ViewChild('quantity', { static: true }) quantityProduct?: ElementRef;\n  @ViewChild('client', { static: true }) cliente?: ElementRef;\n  @ViewChild('pay', { static: true }) pago?: ElementRef;\n  constructor(private fb: FormBuilder, private routes: Router,\n     private comunicatorSvc: ComunicatorComponetsService,\n     private productsSvc: ProductosService,\n     private coinsSvc:CoinsService,\n     protected override renderer: Renderer2,\n     private clientesSvc:ClientesService) {\n    super();\n  }\n  ngOnInit() {\n    let title: string[] = [];\n    let ruta;\n    setTimeout(() => {\n      /* Obtengo la ruta actual y la transformo para obtener el titulo del componente*/\n      ruta = this.routes.url.slice((this.routes.url.slice(1).indexOf('/')) + 2);\n      title.push(\"fas fa-cart-plus fa-fw\");//aañado el icono del titulo al array\n      title.push(decodeURI(ruta).toUpperCase());//añado el titulo al array\n      this.comunicatorSvc.setTitleComponent(title);\n    });\n    this.coinsSvc.getCoins().subscribe({ \n      next: res => {\n      this.coins = res\n      res.forEach((coin: coin) => {\n        if (coin.type === 'principal')\n          this.coinSelected = coin\n      })\n    },\n    complete:()=>{\n      this.formNewSell.get('coin')?.setValue(this.coinSelected.symbol)\n    }})\n    this.clientesSvc.getClients().subscribe(clientes=>{\n      this.clientes=clientes\n      clientes.forEach((cliente:client)=>{\n        if(cliente.names.includes('Publico')){\n          this.formNewSell.get('client')?.setValue(cliente.document_number)\n        }\n      })\n    })\n    this.productsSvc.getProductos().subscribe(res=>this.listProducts=res)\n    this.formNewSell = this.fb.group({\n        barcode: new FormControl('',[Validators.required, Validators.pattern(/^[0-9]+$/)]),\n        productQuantity: new FormControl('',[Validators.pattern(/^[0-9]+$/)]),\n        client:new FormControl(''),\n        productQuantityBySearch:new FormControl(''),\n        coin:new FormControl(''),\n        date: new FormControl(''),\n        time: new FormControl(''),\n        discount:new FormControl('',[Validators.pattern(/^[0-9]+$/)]),\n      })\n      this.tableSearch = new FormGroup({\n        search: new FormControl(),\n      });\n  }\n  selectMoneda() {\n    this.coins.forEach((coin) => {\n      if (coin.symbol === this.formNewSell.get('coin')?.value) {\n        this.coinSelected = coin\n      }\n    })\n  }\n  verificarProductoAñadido(product: product) {\n    let exist: boolean = false\n    this.products.forEach((producto: product) => {\n      if (producto.name === product.name) {\n        exist = true\n      } else {\n        exist = false\n      }\n    })\n    return exist\n  }\n  addQuantity(product: product) {\n    let values = {\n      icon: 'fa-regular fa-circle-xmark',\n      title: 'Ocurrió un error inesperado',\n      content: ''\n    }\n    if (this.verificarProductoAñadido(product)) {\n      values.content='Este producto ya se encuentra agregado a la venta'\n      this.changeModal(values)\n      this.popUp?.nativeElement.showModal()\n    }else if(product.exist_quantity===0){\n      values.content='No hay existencias de este producto para vender'\n      this.changeModal(values)\n      this.popUp?.nativeElement.showModal()\n    } else {\n      this.quantityProduct?.nativeElement.showModal()\n     this.product = product\n    }\n  }\nopen(){\n  this.cliente?.nativeElement.showModal()\n}\nreceiveMessage(client:client) {\n  this.clientes.push(client)\n  console.log(this.clientes)\n  console.log(client)\n  this.formNewSell.get('client')?.setValue(client.document_number)\n  this.cancel(this.cliente)\n}\n  addProduct() {\n    let quantity: number\n    if (this.formNewSell.get('productQuantity')?.value === '') {\n      quantity = 1\n    } else {\n      quantity = this.formNewSell.get('productQuantity')?.value\n    }\n\n    if (this.formNewSell.get('barcode')?.valid) {\n      this.productsSvc.getProductoByBarcode(this.formNewSell.get('barcode')?.value).subscribe(\n        product => {\n          if (product instanceof Array) {\n\n            if (!this.verificarProductoAñadido(product[0])) {\n               this.sellProducts.push({\n                id_sell: 0, id_product: product[0].id_product,\n                buy_price: 0, sell_price: 0,discount_product:0,impuest:0, quantity_products: quantity,\n                exist_products: 0, quantity_back: 0\n              }) \n              this.products.push(product[0])\n            }\n          } else {\n            this.changeModal(product)\n            this.popUp?.nativeElement.showModal()\n            this.formNewSell.get('barcode')?.setValue('')\n            this.formNewSell.get('productQuantity')?.setValue('')\n          }\n        })\n    }\n  }\n  addProductBySearch(product: product) {\n    let quantity = this.formNewSell.get('productQuantityBySearch')?.value\n    this.sellProducts.push({\n      id_sell: 0, id_product: product.id_product,\n      buy_price: 0, sell_price: 0,discount_product:0,impuest:0, quantity_products: quantity,\n      exist_products: 0, quantity_back: 0\n    }) \n    this.products.push(product)\n    this.cancel(this.quantityProduct)\n    this.cancel(this.search)\n  }\n  acept(index: number) {\n    if (this.popUp?.nativeElement.children[1].textContent.includes('error')) {\n      this.popUp?.nativeElement.close()\n    } else if (this.popUp?.nativeElement.children[1].textContent.includes('¿Estás seguro?')) {\n      this.delete(index)\n      this.popUp?.nativeElement.close()\n    } else {\n      this.popUp?.nativeElement.close()\n    }\n  }\n  calcularSubtotal(product: product, index: number) {\n    return (this.products[index].sell_price * this.sellProducts[index].quantity_products)-\n    (this.products[index].sell_price * this.products[index].discount*this.sellProducts[index].quantity_products)\n  }\n\n  calcularTotal(){\n      let total = 0\n      this.products.forEach((product: product, index: number) => {\n        total += (this.products[index].sell_price * this.sellProducts[index].quantity_products)-\n        (this.products[index].sell_price * this.products[index].discount*this.sellProducts[index].quantity_products)\n      });\n      \n      return this.comunicatorSvc.converter(total,this.coinSelected)\n  }\n  calcularDescuentoVenta(){\n    return (Number(this.formNewSell.get('discount')?.value)/100)*this.calcularTotal()\n  }\n  calcularImpuestoVenta(){\n    let montoImponible=0\n    this.products.forEach((product:product,index: number)=>{\n      if(product.impuest>0){\n        montoImponible+=product.impuest*((product.sell_price * this.sellProducts[index].quantity_products)-\n        (product.sell_price * product.discount*this.sellProducts[index].quantity_products))\n      }\n    })\n    return this.comunicatorSvc.converter(montoImponible,this.coinSelected)\n  }\n  total(){\n    return (this.calcularTotal()+this.calcularImpuestoVenta()-this.calcularDescuentoVenta())\n  }\n  searchProduct() {\n    this.search?.nativeElement.showModal();\n  }\n  delete(index: number) {\n    this.products.splice(this.indexElementToDelete, 1)\n    this.sellProducts.splice(this.indexElementToDelete, 1)\n  }\n  validarVenta() {\n    let result = { isValid: false, msj: 'Agrege productos a la venta' }\n    this.products.forEach((product: product, index: number) => {\n      if(this.sellProducts[index].quantity_products===0){\n        result = { isValid: false, msj: 'La cantidad a vender del producto '+product.name+'no puede ser 0'}\n      }else if (this.sellProducts[index].quantity_products> product.exist_quantity) {\n        result = { isValid: false, msj: 'La cantidad a vender del producto '+product.name+' es mayor a la existente' }\n      } else {\n        result = { isValid: true, msj: '' }\n      }\n    })\n    return result\n  }\n  agregarPago(){\n    this.pago?.nativeElement.showModal();\n  }\n\n}\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}