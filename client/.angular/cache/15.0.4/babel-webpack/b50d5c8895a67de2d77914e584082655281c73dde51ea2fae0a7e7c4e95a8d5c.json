{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, ViewChild } from '@angular/core';\nimport { FormControl, FormGroup, Validators } from '@angular/forms';\nimport { DinamicInput } from 'src/app/utils/DinamicInput';\nlet NuevaCompraComponent = class NuevaCompraComponent extends DinamicInput {\n  constructor(fb, routes, comunicatorSvc, providersSvc, productsSvc, renderer, comprasServices, coinsSvc) {\n    super();\n    this.fb = fb;\n    this.routes = routes;\n    this.comunicatorSvc = comunicatorSvc;\n    this.providersSvc = providersSvc;\n    this.productsSvc = productsSvc;\n    this.renderer = renderer;\n    this.comprasServices = comprasServices;\n    this.coinsSvc = coinsSvc;\n    this.providers = [];\n    this.products = [];\n    this.listProductsToBuy = [];\n    this.listProducts = [];\n    this.date = new Date();\n    this.coins = [];\n  }\n  ngOnInit() {\n    let title = [];\n    let ruta;\n    setTimeout(() => {\n      /* Obtengo la ruta actual y la transformo para obtener el titulo del componente*/\n      ruta = this.routes.url.slice(this.routes.url.slice(1).indexOf('/') + 2);\n      title.push(decodeURI(ruta).toUpperCase()); //añado el titulo al array\n      title.push(\"fas fa-shopping-bag fa-fw\"); //aañado el icono del titulo al array\n      this.comunicatorSvc.setTitleComponent(title);\n    });\n    this.providersSvc.getProviders().subscribe(providers => this.providers = providers);\n    this.coinsSvc.getCoins().subscribe(res => this.coins = res);\n    this.productsSvc.getProductos().subscribe(res => this.listProducts = res);\n    this.formNewBuy = this.fb.group({\n      barcode: new FormControl('', [Validators.required, Validators.pattern(/^[0-9]+$/)]),\n      productQuantity: new FormControl('', [Validators.pattern(/^[0-9]+$/)]),\n      productQuantityBySearch: new FormControl('', [Validators.pattern(/^[0-9]+$/)]),\n      coin: new FormControl('Bs.S'),\n      provider: new FormControl('')\n    });\n    this.tableSearch = new FormGroup({\n      search: new FormControl()\n    });\n  }\n  verificarProductoAñadido(product) {\n    let exist = false;\n    this.products.forEach(producto => {\n      if (producto.name === product.name) {\n        exist = true;\n      } else {\n        exist = false;\n      }\n    });\n    return exist;\n  }\n  addProduct() {\n    let quantity;\n    if (this.formNewBuy.get('productQuantity')?.value === '') {\n      quantity = 1;\n    } else {\n      quantity = this.formNewBuy.get('productQuantity')?.value;\n    }\n    if (this.formNewBuy.valid) {\n      this.productsSvc.getProductoByBarcode(this.formNewBuy.get('barcode')?.value).subscribe(product => {\n        if (product instanceof Array) {\n          if (!this.verificarProductoAñadido(product[0])) {\n            product[0].expir = null;\n            this.listProductsToBuy.push({\n              id_buy: 0,\n              id_product: product[0].id_product,\n              buy_price: 0,\n              sell_price: 0,\n              weighted_averages: 0,\n              quantity_products: quantity,\n              exist_products: 0,\n              quantity_back: 0\n            });\n            this.products.push(product[0]);\n          }\n        } else {\n          this.changeModal(product);\n          this.popUp?.nativeElement.showModal();\n          this.formNewBuy.get('barcode')?.setValue('');\n          this.formNewBuy.get('productQuantity')?.setValue('');\n        }\n      });\n    }\n  }\n  addQuantity(product) {\n    if (this.verificarProductoAñadido(product)) {\n      let values = {\n        icon: 'fa-regular fa-circle-xmark',\n        title: 'Ocurrió un error inesperado',\n        content: 'Este producto ya se encuentra agregado a la compra'\n      };\n      this.changeModal(values);\n      this.popUp?.nativeElement.showModal();\n    } else {\n      this.quantityProduct?.nativeElement.showModal();\n      this.product = product;\n    }\n  }\n  addProductBySearch(product) {\n    let quantity = this.formNewBuy.get('productQuantityBySearch')?.value;\n    this.listProductsToBuy.push({\n      id_buy: 0,\n      id_product: product.id_product,\n      buy_price: 0,\n      sell_price: 0,\n      weighted_averages: 0,\n      quantity_products: quantity,\n      exist_products: 0,\n      quantity_back: 0\n    });\n    this.products.push(product);\n    this.cancel(this.quantityProduct);\n    this.cancel(this.search);\n  }\n  calcularSubtotal(product, index) {\n    return this.listProductsToBuy[index].buy_price * this.listProductsToBuy[index].quantity_products;\n  }\n  calcularTotal() {\n    let total = 0;\n    this.products.forEach((product, index) => {\n      total += this.listProductsToBuy[index].buy_price * this.listProductsToBuy[index].quantity_products;\n    });\n    return total;\n  }\n  delete(index) {\n    this.products.splice(index, 1);\n    this.listProductsToBuy.splice(index, 1);\n  }\n  searchProduct() {\n    this.search?.nativeElement.showModal();\n  }\n  validarCompra() {\n    let result = {\n      isValid: false,\n      msj: 'Agrege productos a la compra'\n    };\n    this.products.forEach((product, index) => {\n      if (this.formNewBuy.get('provider')?.value === '') {\n        result = {\n          isValid: false,\n          msj: 'Debe selecionar un proveedor'\n        };\n      } else if (product.expir === null && product.can_expir) {\n        result = {\n          isValid: false,\n          msj: 'La fecha de vencimiento del ' + product.name + ' es invalida'\n        };\n      } else {\n        this.listProductsToBuy.forEach(productBuy => {\n          if (productBuy.quantity_products < 1) {\n            result = {\n              isValid: false,\n              msj: 'La cantidad del' + product.name + 'no puede ser 0'\n            };\n          } else if (Number(productBuy.buy_price) === 0) {\n            result = {\n              isValid: false,\n              msj: 'El precio de compra del producto ' + product.name + 'no puede ser 0'\n            };\n          } else if (Number(productBuy.sell_price) === 0) {\n            result = {\n              isValid: false,\n              msj: 'El precio de venta del producto ' + product.name + ' no puede ser 0'\n            };\n          } else if (Number(productBuy.sell_price) < Number(productBuy.buy_price)) {\n            result = {\n              isValid: false,\n              msj: 'El precio de venta del producto ' + product.name + ' no puede ser menor al precio de compra'\n            };\n          } else {\n            result = {\n              isValid: true,\n              msj: ''\n            };\n          }\n        });\n      }\n    });\n    return result;\n  }\n  validate(event, hasDecimal) {\n    let key;\n    let regex;\n    if (event.type === 'paste') {\n      key = event.clipboardData.getData('text/plain');\n    } else {\n      key = event.keyCode;\n      key = String.fromCharCode(key);\n    }\n    if (hasDecimal) {\n      regex = /[0-9]|\\./;\n    } else {\n      regex = /[0-9]/;\n    }\n    if (!regex.test(key) || key === '.' && event.target.value.includes('.')) {\n      event.returnValue = false;\n      if (event.preventDefault) {\n        event.preventDefault();\n      }\n    }\n  }\n  acept(index) {\n    if (this.popUp?.nativeElement.children[1].textContent.includes('error')) {\n      this.popUp?.nativeElement.close();\n    } else if (this.popUp?.nativeElement.children[1].textContent.includes('¿Estás seguro?')) {\n      this.delete(index);\n      this.popUp?.nativeElement.close();\n    } else {\n      this.popUp?.nativeElement.close();\n    }\n  }\n  registrarCompra() {\n    if (this.validarCompra().isValid) {\n      this.products.forEach((product, index) => {\n        this.listProductsToBuy[index].exist_products = Number(product.exist_quantity) + Number(this.listProductsToBuy[index].quantity_products);\n        this.listProductsToBuy[index].weighted_averages = (Number(product.sell_price) * Number(product.exist_quantity) + Number(this.listProductsToBuy[index].sell_price) * Number(this.listProductsToBuy[index].quantity_products)) / Number(this.listProductsToBuy[index].exist_products);\n        product.sell_price = this.listProductsToBuy[index].weighted_averages;\n        product.buy_price = (Number(product.buy_price) * Number(product.exist_quantity) + Number(this.listProductsToBuy[index].buy_price) * Number(this.listProductsToBuy[index].quantity_products)) / this.listProductsToBuy[index].exist_products;\n        product.exist_quantity = this.listProductsToBuy[index].exist_products;\n      });\n      console.log(this.listProductsToBuy);\n      let buy = {\n        total_buy: this.calcularTotal(),\n        coin: this.formNewBuy.get('coin')?.value.toString(),\n        id_provider: Number(this.formNewBuy.get('provider')?.value),\n        buy_products: this.listProductsToBuy,\n        id_user: 16\n      };\n      this.comprasServices.setBuy(buy).subscribe({\n        next: res => {\n          console.log(res);\n          this.changeModal(res);\n          this.popUp?.nativeElement.showModal();\n        },\n        complete: () => {\n          this.products.forEach(product => {\n            this.productsSvc.updateProducto(product.id_product, product).subscribe();\n          });\n        }\n      });\n    }\n  }\n};\n__decorate([ViewChild('popup', {\n  static: true\n})], NuevaCompraComponent.prototype, \"popUp\", void 0);\n__decorate([ViewChild('tab', {\n  static: true\n})], NuevaCompraComponent.prototype, \"tab\", void 0);\n__decorate([ViewChild('searchProducts', {\n  static: true\n})], NuevaCompraComponent.prototype, \"search\", void 0);\n__decorate([ViewChild('quantity', {\n  static: true\n})], NuevaCompraComponent.prototype, \"quantityProduct\", void 0);\nNuevaCompraComponent = __decorate([Component({\n  selector: 'app-nueva-compra',\n  templateUrl: './nueva-compra.component.html',\n  styleUrls: ['./nueva-compra.component.css']\n})], NuevaCompraComponent);\nexport { NuevaCompraComponent };","map":{"version":3,"mappings":"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","names":["Component","ViewChild","FormControl","FormGroup","Validators","DinamicInput","NuevaCompraComponent","constructor","fb","routes","comunicatorSvc","providersSvc","productsSvc","renderer","comprasServices","coinsSvc","Date","ngOnInit","title","ruta","setTimeout","url","slice","indexOf","push","decodeURI","toUpperCase","setTitleComponent","getProviders","subscribe","providers","getCoins","res","coins","getProductos","listProducts","formNewBuy","group","barcode","required","pattern","productQuantity","productQuantityBySearch","coin","provider","tableSearch","search","verificarProductoAñadido","product","exist","products","forEach","producto","name","addProduct","quantity","get","value","valid","getProductoByBarcode","Array","expir","listProductsToBuy","id_buy","id_product","buy_price","sell_price","weighted_averages","quantity_products","exist_products","quantity_back","changeModal","popUp","nativeElement","showModal","setValue","addQuantity","values","icon","content","quantityProduct","addProductBySearch","cancel","calcularSubtotal","index","calcularTotal","total","delete","splice","searchProduct","validarCompra","result","isValid","msj","can_expir","productBuy","Number","validate","event","hasDecimal","key","regex","type","clipboardData","getData","keyCode","String","fromCharCode","test","target","includes","returnValue","preventDefault","acept","children","textContent","close","registrarCompra","exist_quantity","console","log","buy","total_buy","toString","id_provider","buy_products","id_user","setBuy","next","complete","updateProducto","__decorate","static","selector","templateUrl","styleUrls"],"sourceRoot":"","sources":["/home/luis/Documentos/systems vs code/inventary-system/client/src/app/content/compras/nueva-compra/nueva-compra.component.ts"],"sourcesContent":["import { Component, ElementRef, Renderer2, ViewChild } from '@angular/core';\nimport { FormBuilder, FormControl, FormGroup, Validators } from '@angular/forms';\nimport { Router } from '@angular/router';\nimport { buy_product, product, provider, buy, coin } from 'src/app/interfaces/interfaces';\nimport { ComunicatorComponetsService } from 'src/app/services/comunicator/comunicator-componets.service';\nimport { DinamicInput } from 'src/app/utils/DinamicInput';\nimport { ProveedoresService } from '../../administracion/proveedores/service/proveedores.service';\nimport { ProductosService } from '../../productos/productos-en-almacen/service/productos.service';\nimport { ComprasService } from '../service/compras.service';\nimport { CoinsService } from '../../configuraciones/service/coins.service';\n@Component({\n  selector: 'app-nueva-compra',\n  templateUrl: './nueva-compra.component.html',\n  styleUrls: ['./nueva-compra.component.css']\n})\n\nexport class NuevaCompraComponent extends DinamicInput {\n\n  formNewBuy!: FormGroup;\n  tableSearch!: FormGroup;\n  providers: provider[] = []\n  products: product[] = []\n  listProductsToBuy: buy_product[] = []\n  product!: product\n  listProducts: product[] = []\n  date = new Date()\n  price!: number;\n  coins:coin[]=[]\n\n  @ViewChild('popup', { static: true }) override popUp?: ElementRef;\n  @ViewChild('tab', { static: true }) tab?: ElementRef;\n  @ViewChild('searchProducts', { static: true }) search?: ElementRef;\n  @ViewChild('quantity', { static: true }) quantityProduct?: ElementRef;\n\n  constructor(private fb: FormBuilder,\n    private routes: Router,\n    private comunicatorSvc: ComunicatorComponetsService,\n    private providersSvc: ProveedoresService,\n    private productsSvc: ProductosService,\n    protected override renderer: Renderer2,\n    private comprasServices: ComprasService,\n    private coinsSvc:CoinsService) {\n    super();\n  }\n\n  ngOnInit() {\n\n    let title: string[] = [];\n    let ruta;\n    setTimeout(() => {\n      /* Obtengo la ruta actual y la transformo para obtener el titulo del componente*/\n      ruta = this.routes.url.slice((this.routes.url.slice(1).indexOf('/')) + 2);\n      title.push(decodeURI(ruta).toUpperCase());//añado el titulo al array\n      title.push(\"fas fa-shopping-bag fa-fw\");//aañado el icono del titulo al array\n      this.comunicatorSvc.setTitleComponent(title);\n    });\n\n    this.providersSvc.getProviders().subscribe(\n      providers => this.providers = providers\n    )\n      this.coinsSvc.getCoins().subscribe(res=>this.coins=res)\n\n    this.productsSvc.getProductos().subscribe(res => this.listProducts = res)\n    this.formNewBuy = this.fb.group({\n      barcode: new FormControl('', [Validators.required, Validators.pattern(/^[0-9]+$/)]),\n      productQuantity: new FormControl('', [Validators.pattern(/^[0-9]+$/)]),\n      productQuantityBySearch: new FormControl('', [Validators.pattern(/^[0-9]+$/)]),\n      coin: new FormControl('Bs.S'),\n      provider: new FormControl('')\n    })\n    this.tableSearch = new FormGroup({\n      search: new FormControl(),\n    });\n  }\n\n  verificarProductoAñadido(product: product) {\n    let exist: boolean = false\n    this.products.forEach((producto: product) => {\n      if (producto.name === product.name) {\n        exist = true\n      } else {\n        exist = false\n      }\n    })\n    return exist\n  }\n\n  addProduct() {\n    let quantity: number\n    if (this.formNewBuy.get('productQuantity')?.value === '') {\n      quantity = 1\n    } else {\n      quantity = this.formNewBuy.get('productQuantity')?.value\n    }\n\n    if (this.formNewBuy.valid) {\n      this.productsSvc.getProductoByBarcode(this.formNewBuy.get('barcode')?.value).subscribe(\n        product => {\n          if (product instanceof Array) {\n\n            if (!this.verificarProductoAñadido(product[0])) {\n              product[0].expir = null\n              this.listProductsToBuy.push({\n                id_buy: 0, id_product: product[0].id_product,\n                buy_price: 0, sell_price: 0, weighted_averages: 0, quantity_products: quantity,\n                exist_products: 0, quantity_back: 0\n              })\n              this.products.push(product[0])\n            }\n          } else {\n            this.changeModal(product)\n            this.popUp?.nativeElement.showModal()\n            this.formNewBuy.get('barcode')?.setValue('')\n            this.formNewBuy.get('productQuantity')?.setValue('')\n          }\n        })\n    }\n  }\n  addQuantity(product: product) {\n    if (this.verificarProductoAñadido(product)) {\n      let values = {\n        icon: 'fa-regular fa-circle-xmark',\n        title: 'Ocurrió un error inesperado',\n        content: 'Este producto ya se encuentra agregado a la compra'\n      }\n      this.changeModal(values)\n      this.popUp?.nativeElement.showModal()\n    } else {\n      this.quantityProduct?.nativeElement.showModal()\n      this.product = product\n    }\n  }\n\n\n  addProductBySearch(product: product) {\n    let quantity = this.formNewBuy.get('productQuantityBySearch')?.value\n    this.listProductsToBuy.push({\n      id_buy: 0, id_product: product.id_product,\n      buy_price: 0, sell_price: 0, weighted_averages: 0, quantity_products: quantity,\n      exist_products: 0, quantity_back: 0\n    })\n    this.products.push(product)\n    this.cancel(this.quantityProduct)\n    this.cancel(this.search)\n  }\n\n  calcularSubtotal(product: product, index: number) {\n    return this.listProductsToBuy[index].buy_price * this.listProductsToBuy[index].quantity_products\n  }\n\n  calcularTotal() {\n    let total = 0\n    this.products.forEach((product: product, index: number) => {\n      total += this.listProductsToBuy[index].buy_price * this.listProductsToBuy[index].quantity_products\n    });\n    return total\n  }\n\n  delete(index: number) {\n    this.products.splice(index, 1)\n    this.listProductsToBuy.splice(index, 1)\n  }\n\n  searchProduct() {\n    this.search?.nativeElement.showModal();\n  }\n  validarCompra() {\n    let result = { isValid: false, msj: 'Agrege productos a la compra' }\n    this.products.forEach((product: product, index: number) => {\n      if (this.formNewBuy.get('provider')?.value === '') {\n        result = { isValid: false, msj: 'Debe selecionar un proveedor' }\n      } else if (product.expir === null && product.can_expir) {\n        result = { isValid: false, msj: 'La fecha de vencimiento del ' + product.name + ' es invalida' }\n      } else {\n        this.listProductsToBuy.forEach((productBuy: buy_product) => {\n          if (productBuy.quantity_products < 1) {\n            result = { isValid: false, msj: 'La cantidad del' + product.name + 'no puede ser 0' }\n          } else if (Number(productBuy.buy_price) === 0) {\n            result = { isValid: false, msj: 'El precio de compra del producto ' + product.name + 'no puede ser 0' }\n          } else if (Number(productBuy.sell_price) === 0) {\n            result = { isValid: false, msj: 'El precio de venta del producto ' + product.name + ' no puede ser 0' }\n          } else if (Number(productBuy.sell_price) < Number(productBuy.buy_price)) {\n            result = { isValid: false, msj: 'El precio de venta del producto ' + product.name + ' no puede ser menor al precio de compra' }\n          } else {\n            result = { isValid: true, msj: '' }\n          }\n        })\n      }\n\n\n    })\n\n    return result\n  }\n\n  validate(event: any, hasDecimal: boolean) {\n    let key;\n    let regex;\n\n    if (event.type === 'paste') {\n      key = event.clipboardData.getData('text/plain')\n    } else {\n      key = event.keyCode;\n      key = String.fromCharCode(key)\n    }\n\n    if (hasDecimal) {\n      regex = /[0-9]|\\./;\n    } else {\n      regex = /[0-9]/;\n    }\n    if (!regex.test(key) || ((key === '.') && event.target.value.includes('.'))) {\n      event.returnValue = false;\n      if (event.preventDefault) {\n        event.preventDefault()\n      }\n    }\n  }\n\n  acept(index: number) {\n    if (this.popUp?.nativeElement.children[1].textContent.includes('error')) {\n      this.popUp?.nativeElement.close()\n    } else if (this.popUp?.nativeElement.children[1].textContent.includes('¿Estás seguro?')) {\n      this.delete(index)\n      this.popUp?.nativeElement.close()\n    } else {\n      this.popUp?.nativeElement.close()\n    }\n  }\n\n  registrarCompra() {\n    if (this.validarCompra().isValid) {\n\n      \n      this.products.forEach((product: product, index: number) => {\n        this.listProductsToBuy[index].exist_products = Number(product.exist_quantity) +\n          Number(this.listProductsToBuy[index].quantity_products)\n        this.listProductsToBuy[index].weighted_averages = ((Number(product.sell_price) * \n        Number(product.exist_quantity)) +\n          (Number(this.listProductsToBuy[index].sell_price) * \n          Number(this.listProductsToBuy[index].quantity_products))) /\n          Number(this.listProductsToBuy[index].exist_products)\n        product.sell_price = this.listProductsToBuy[index].weighted_averages\n        product.buy_price = ((Number(product.buy_price) * Number(product.exist_quantity)) +\n          (Number(this.listProductsToBuy[index].buy_price) * Number(this.listProductsToBuy[index].quantity_products))) /\n          this.listProductsToBuy[index].exist_products\n        product.exist_quantity = this.listProductsToBuy[index].exist_products\n        \n      })\n      console.log(this.listProductsToBuy)\n      let buy: buy = {\n        total_buy: this.calcularTotal(),\n        coin: this.formNewBuy.get('coin')?.value.toString(),\n        id_provider: Number(this.formNewBuy.get('provider')?.value),\n        buy_products: this.listProductsToBuy,\n        id_user: 16\n      }\n      this.comprasServices.setBuy(buy).subscribe({\n        next: res => {\n          console.log(res)\n          this.changeModal(res);\n          this.popUp?.nativeElement.showModal()\n        },\n        complete: () => {\n          this.products.forEach((product: product) => {\n            this.productsSvc.updateProducto(product.id_product, product).subscribe()\n          })\n        }\n      })\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}