{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, ViewChild } from '@angular/core';\nimport { FormControl, FormGroup, Validators } from '@angular/forms';\nimport { DinamicInput } from 'src/app/utils/DinamicInput';\nimport { formatCurrency, registerLocaleData } from '@angular/common';\nimport localeEs from '@angular/common/locales/es';\nregisterLocaleData(localeEs);\nlet NuevaCompraComponent = class NuevaCompraComponent extends DinamicInput {\n  constructor(fb, routes, comunicatorSvc, providersSvc, productsSvc, renderer, currencyPipe) {\n    super();\n    this.fb = fb;\n    this.routes = routes;\n    this.comunicatorSvc = comunicatorSvc;\n    this.providersSvc = providersSvc;\n    this.productsSvc = productsSvc;\n    this.renderer = renderer;\n    this.currencyPipe = currencyPipe;\n    this.providers = [];\n    this.products = [];\n    this.quantity = [];\n    this.listProducts = [];\n    this.date = new Date();\n  }\n  ngOnInit() {\n    let title = [];\n    let ruta;\n    setTimeout(() => {\n      /* Obtengo la ruta actual y la transformo para obtener el titulo del componente*/\n      ruta = this.routes.url.slice(this.routes.url.slice(1).indexOf('/') + 2);\n      title.push(decodeURI(ruta).toUpperCase()); //añado el titulo al array\n      title.push(\"fas fa-shopping-bag fa-fw\"); //aañado el icono del titulo al array\n      this.comunicatorSvc.setTitleComponent(title);\n    });\n    setInterval(() => {\n      this.date = new Date();\n    }, 1000);\n    this.providersSvc.getProviders().subscribe(providers => this.providers = providers);\n    this.productsSvc.getProductos().subscribe(res => this.listProducts = res);\n    this.formNewBuy = this.fb.group({\n      barcode: new FormControl('', [Validators.required, Validators.pattern(/^[0-9]+$/)]),\n      productQuantity: new FormControl('', [Validators.pattern(/^[0-9]+$/)]),\n      productQuantityBySearch: new FormControl('', [Validators.pattern(/^[0-9]+$/)]),\n      coin: new FormControl('Bs.S')\n    });\n    this.tableSearch = new FormGroup({\n      search: new FormControl()\n    });\n    this.formNewBuy.valueChanges.subscribe(form => {\n      for (var key in form) {\n        if (key.includes('price')) {\n          console.log(key + ' ' + form[key]);\n          /*  this.formNewBuy.get(key)?.setValue(this.currencyPipe.transform(\n             form[key].toUpperCase(),'USD','symbol','1.0-0')) */\n          /* this.formNewBuy.patchValue({\n            \n           /*  barcode:this.currencyPipe.transform(form.barcode.replace(/\\D/g,'').replace(/^0+/,''),'USD','symbol','1.0-0') */\n          //},{emitEvent:false}) */\n        }\n      }\n    });\n  }\n\n  verificarProductoAñadido(product) {\n    let exist = false;\n    this.products.forEach(producto => {\n      if (producto.name === product.name) {\n        exist = true;\n      } else {\n        exist = false;\n      }\n    });\n    return exist;\n  }\n  addProduct() {\n    let quantity;\n    if (this.formNewBuy.get('productQuantity')?.value === '') {\n      quantity = 1;\n    } else {\n      quantity = this.formNewBuy.get('productQuantity')?.value;\n    }\n    if (this.formNewBuy.valid) {\n      this.productsSvc.getProductoByBarcode(this.formNewBuy.get('barcode')?.value).subscribe(product => {\n        if (product instanceof Array) {\n          if (!this.verificarProductoAñadido(product[0])) {\n            this.formNewBuy.addControl('cant' + product[0].id_product, new FormControl(quantity));\n            this.formNewBuy.addControl('price' + product[0].id_product, new FormControl(0.00));\n            this.products.push(product[0]);\n            this.quantity.push(quantity);\n          }\n        } else {\n          this.changeModal(product);\n          this.popUp?.nativeElement.showModal();\n          this.formNewBuy.get('barcode')?.setValue('');\n          this.formNewBuy.get('productQuantity')?.setValue('');\n        }\n      });\n    }\n  }\n  addQuantity(product) {\n    if (this.verificarProductoAñadido(product)) {\n      let values = {\n        icon: 'fa-regular fa-circle-xmark',\n        title: 'Ocurrió un error inesperado',\n        content: 'Este producto ya se encuentra agregado a la compra'\n      };\n      this.changeModal(values);\n      this.popUp?.nativeElement.showModal();\n    } else {\n      this.quantityProduct?.nativeElement.showModal();\n      this.product = product;\n    }\n  }\n  addProductBySearch(product) {\n    let quantity = this.formNewBuy.get('productQuantityBySearch')?.value;\n    this.formNewBuy.addControl('cant' + product.id_product, new FormControl(quantity));\n    this.formNewBuy.addControl('price' + product.id_product, new FormControl(formatCurrency(0.00, 'es-ES', '', '1.9')));\n    this.quantity.push(quantity);\n    this.products.push(product);\n    this.cancel(this.quantityProduct);\n    this.cancel(this.search);\n  }\n  calcularSubtotal(product) {\n    product.buy_price = Number(this.formNewBuy.get('cant' + product.id_product)?.value) * Number(this.formNewBuy.get('price' + product.id_product)?.value);\n    return product.buy_price;\n  }\n  calcularTotal() {\n    let total = 0;\n    this.products.forEach(product => {\n      total += product.buy_price;\n    });\n    return total;\n  }\n  delete(index) {\n    this.products.splice(index, 1);\n  }\n  searchProduct() {\n    this.search?.nativeElement.showModal();\n  }\n  validate(event, hasDecimal) {\n    let key;\n    let regex;\n    if (event.type === 'paste') {\n      key = event.clipboardData.getData('text/plain');\n    } else {\n      key = event.keyCode;\n      key = String.fromCharCode(key);\n    }\n    if (hasDecimal) {\n      regex = /[0-9]|\\./;\n    } else {\n      regex = /[0-9]/;\n    }\n    if (!regex.test(key) || key === '.' && event.target.value.includes('.')) {\n      event.returnValue = false;\n      if (event.preventDefault) {\n        event.preventDefault();\n      }\n    }\n  }\n  acept(index) {\n    if (this.popUp?.nativeElement.children[1].textContent.includes('error')) {\n      this.popUp?.nativeElement.close();\n    } else if (this.popUp?.nativeElement.children[1].textContent.includes('¿Estás seguro?')) {\n      this.delete(index);\n      this.popUp?.nativeElement.close();\n    }\n  }\n};\n__decorate([ViewChild('popup', {\n  static: true\n})], NuevaCompraComponent.prototype, \"popUp\", void 0);\n__decorate([ViewChild('tab', {\n  static: true\n})], NuevaCompraComponent.prototype, \"tab\", void 0);\n__decorate([ViewChild('searchProducts', {\n  static: true\n})], NuevaCompraComponent.prototype, \"search\", void 0);\n__decorate([ViewChild('quantity', {\n  static: true\n})], NuevaCompraComponent.prototype, \"quantityProduct\", void 0);\nNuevaCompraComponent = __decorate([Component({\n  selector: 'app-nueva-compra',\n  templateUrl: './nueva-compra.component.html',\n  styleUrls: ['./nueva-compra.component.css']\n})], NuevaCompraComponent);\nexport { NuevaCompraComponent };","map":{"version":3,"mappings":"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","names":["Component","ViewChild","FormControl","FormGroup","Validators","DinamicInput","formatCurrency","registerLocaleData","localeEs","NuevaCompraComponent","constructor","fb","routes","comunicatorSvc","providersSvc","productsSvc","renderer","currencyPipe","Date","ngOnInit","title","ruta","setTimeout","url","slice","indexOf","push","decodeURI","toUpperCase","setTitleComponent","setInterval","date","getProviders","subscribe","providers","getProductos","res","listProducts","formNewBuy","group","barcode","required","pattern","productQuantity","productQuantityBySearch","coin","tableSearch","search","valueChanges","form","key","includes","console","log","verificarProductoAñadido","product","exist","products","forEach","producto","name","addProduct","quantity","get","value","valid","getProductoByBarcode","Array","addControl","id_product","changeModal","popUp","nativeElement","showModal","setValue","addQuantity","values","icon","content","quantityProduct","addProductBySearch","cancel","calcularSubtotal","buy_price","Number","calcularTotal","total","delete","index","splice","searchProduct","validate","event","hasDecimal","regex","type","clipboardData","getData","keyCode","String","fromCharCode","test","target","returnValue","preventDefault","acept","children","textContent","close","__decorate","static","selector","templateUrl","styleUrls"],"sourceRoot":"","sources":["/home/luis/Documentos/systems vs code/inventary-system/client/src/app/content/compras/nueva-compra/nueva-compra.component.ts"],"sourcesContent":["import { Component, ElementRef, Renderer2, ViewChild } from '@angular/core';\nimport { FormBuilder, FormControl, FormGroup, Validators } from '@angular/forms';\nimport { Router } from '@angular/router';\nimport { product, provider } from 'src/app/interfaces/interfaces';\nimport { ComunicatorComponetsService } from 'src/app/services/comunicator/comunicator-componets.service';\nimport { DinamicInput } from 'src/app/utils/DinamicInput';\nimport { ProveedoresService } from '../../administracion/proveedores/service/proveedores.service';\nimport { ProductosService } from '../../productos/productos-en-almacen/service/productos.service';\nimport { CurrencyPipe, formatCurrency, registerLocaleData } from '@angular/common';\nimport localeEs from '@angular/common/locales/es'\nregisterLocaleData(localeEs)\n@Component({\n  selector: 'app-nueva-compra',\n  templateUrl: './nueva-compra.component.html',\n  styleUrls: ['./nueva-compra.component.css']\n})\n\nexport class NuevaCompraComponent extends DinamicInput {\n\n  formNewBuy!: FormGroup;\n  tableSearch!: FormGroup;\n  providers: provider[] = []\n  products: product[] = []\n  product!:product\n  quantity: number[] = []\n  listProducts: product[] = []\n  date = new Date()\n  @ViewChild('popup', { static: true }) override popUp?: ElementRef;\n  @ViewChild('tab', { static: true }) tab?: ElementRef;\n  @ViewChild('searchProducts', { static: true }) search?: ElementRef;\n  @ViewChild('quantity', { static: true }) quantityProduct?: ElementRef;\n\n  constructor(private fb: FormBuilder,\n    private routes: Router,\n    private comunicatorSvc: ComunicatorComponetsService,\n    private providersSvc: ProveedoresService,\n    private productsSvc: ProductosService,\n    protected override renderer: Renderer2,\n    private currencyPipe:CurrencyPipe) {\n    super();\n  }\n\n  ngOnInit() {\n    let title: string[] = [];\n    let ruta;\n    setTimeout(() => {\n      /* Obtengo la ruta actual y la transformo para obtener el titulo del componente*/\n      ruta = this.routes.url.slice((this.routes.url.slice(1).indexOf('/')) + 2);\n      title.push(decodeURI(ruta).toUpperCase());//añado el titulo al array\n      title.push(\"fas fa-shopping-bag fa-fw\");//aañado el icono del titulo al array\n      this.comunicatorSvc.setTitleComponent(title);\n    });\n    setInterval(() => {\n      this.date = new Date()\n    }, 1000)\n    this.providersSvc.getProviders().subscribe(\n      providers => this.providers = providers\n    )\n    this.productsSvc.getProductos().subscribe(res=>this.listProducts=res)\n    this.formNewBuy = this.fb.group({\n      barcode: new FormControl('', [Validators.required, Validators.pattern(/^[0-9]+$/)]),\n      productQuantity: new FormControl('', [Validators.pattern(/^[0-9]+$/)]),\n      productQuantityBySearch: new FormControl('', [Validators.pattern(/^[0-9]+$/)]),\n      coin:new FormControl('Bs.S')\n    })\n    this.tableSearch = new FormGroup({\n      search: new FormControl(),\n    });\n    this.formNewBuy.valueChanges.subscribe(form=>{\n      for (var key in form) {\n        if(key.includes('price')){\n          console.log(key+' '+form[key])\n         /*  this.formNewBuy.get(key)?.setValue(this.currencyPipe.transform(\n            form[key].toUpperCase(),'USD','symbol','1.0-0')) */\n          /* this.formNewBuy.patchValue({\n            \n           /*  barcode:this.currencyPipe.transform(form.barcode.replace(/\\D/g,'').replace(/^0+/,''),'USD','symbol','1.0-0') */\n          //},{emitEvent:false}) */\n        }\n      }\n    })\n  }\n\n  \n\n  verificarProductoAñadido(product:product){\n    let exist: boolean = false\n    this.products.forEach((producto: product) => {\n      if (producto.name === product.name) {\n        exist = true\n      } else {\n        exist = false\n      }\n    })\n    return exist\n  }\n  addProduct() {\n    let quantity:number\n    if(this.formNewBuy.get('productQuantity')?.value===''){\n      quantity=1\n    }else{\n      quantity=this.formNewBuy.get('productQuantity')?.value\n    }\n    \n    if (this.formNewBuy.valid) {\n      this.productsSvc.getProductoByBarcode(this.formNewBuy.get('barcode')?.value).subscribe(\n        product => {\n          if (product instanceof Array) {\n           \n            if (!this.verificarProductoAñadido(product[0])) {\n              this.formNewBuy.addControl('cant' + product[0].id_product, new FormControl(quantity))\n              this.formNewBuy.addControl('price' + product[0].id_product, new FormControl(0.00))\n              this.products.push(product[0])\n              this.quantity.push(quantity)\n            }\n          } else {\n            this.changeModal(product)\n            this.popUp?.nativeElement.showModal()\n            this.formNewBuy.get('barcode')?.setValue('')\n            this.formNewBuy.get('productQuantity')?.setValue('')\n          }\n        })\n    }\n  }\n  addQuantity(product:product){\n    if(this.verificarProductoAñadido(product)){\n      let values={\n        icon:'fa-regular fa-circle-xmark',\n        title:'Ocurrió un error inesperado',\n        content:'Este producto ya se encuentra agregado a la compra'\n      }\n      this.changeModal(values)\n      this.popUp?.nativeElement.showModal()\n    }else{\n      this.quantityProduct?.nativeElement.showModal()\n      this.product=product\n    }\n  }\n\n  addProductBySearch(product:product){\n    let quantity=this.formNewBuy.get('productQuantityBySearch')?.value\n    this.formNewBuy.addControl('cant' + product.id_product, new FormControl(quantity))\n    this.formNewBuy.addControl('price' + product.id_product, new FormControl(formatCurrency(0.00,'es-ES','','1.9')))\n    this.quantity.push(quantity)\n    this.products.push(product)\n    this.cancel(this.quantityProduct)\n    this.cancel(this.search)\n  }\n\n  calcularSubtotal(product: product) {\n    product.buy_price=Number(this.formNewBuy.get('cant' + product.id_product)?.value) *\n    Number(this.formNewBuy.get('price' + product.id_product)?.value)\n    return product.buy_price\n  }\n\n  calcularTotal(){\n    let total=0\n    this.products.forEach((product:product) => {\n      total+=product.buy_price\n    });\n    return total\n  }\n  \n  delete(index: number) {\n    this.products.splice(index, 1)\n  }\n\n  searchProduct() {\n   this.search?.nativeElement.showModal();\n  }\n \n  validate(event:any,hasDecimal:boolean){\n    let key;\n    let regex;\n    \n    if(event.type==='paste'){\n      key=event.clipboardData.getData('text/plain')\n    }else{\n      key=event.keyCode;\n      key=String.fromCharCode(key)\n    }\n    \n    if(hasDecimal){\n      regex=/[0-9]|\\./;\n    }else{\n      regex=/[0-9]/;\n    }\n    if(!regex.test(key)||((key==='.')&&event.target.value.includes('.'))){\n      event.returnValue=false;\n      if(event.preventDefault){\n        event.preventDefault()\n      }\n    }\n  }\n\n  acept(index: number) {\n    if (this.popUp?.nativeElement.children[1].textContent.includes('error')) {\n      this.popUp?.nativeElement.close()\n    } else if (this.popUp?.nativeElement.children[1].textContent.includes('¿Estás seguro?')) {\n      this.delete(index)\n      this.popUp?.nativeElement.close()\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}