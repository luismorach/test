{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, ViewChild } from '@angular/core';\nimport { FormControl, FormGroup, Validators } from '@angular/forms';\nimport { DinamicInput } from 'src/app/utils/DinamicInput';\nlet NuevaVentaComponent = class NuevaVentaComponent extends DinamicInput {\n  constructor(fb, routes, comunicatorSvc, productsSvc, coinsSvc, renderer, clientesSvc) {\n    super();\n    this.fb = fb;\n    this.routes = routes;\n    this.comunicatorSvc = comunicatorSvc;\n    this.productsSvc = productsSvc;\n    this.coinsSvc = coinsSvc;\n    this.renderer = renderer;\n    this.clientesSvc = clientesSvc;\n    this.products = [];\n    this.date = new Date();\n    this.coins = [];\n    this.clientes = [];\n    this.sellProducts = [];\n    this.listProducts = [];\n    this.indexElementToDelete = 0;\n  }\n  ngOnInit() {\n    let title = [];\n    let ruta;\n    setTimeout(() => {\n      /* Obtengo la ruta actual y la transformo para obtener el titulo del componente*/\n      ruta = this.routes.url.slice(this.routes.url.slice(1).indexOf('/') + 2);\n      title.push(decodeURI(ruta).toUpperCase()); //añado el titulo al array\n      title.push(\"fas fa-cart-plus fa-fw\"); //aañado el icono del titulo al array\n      this.comunicatorSvc.setTitleComponent(title);\n    });\n    this.coinsSvc.getCoins().subscribe({\n      next: res => {\n        this.coins = res;\n        res.forEach(coin => {\n          if (coin.type === 'principal') this.coinSelected = coin;\n        });\n      },\n      complete: () => {\n        this.formNewSell.get('coin')?.setValue(this.coinSelected.symbol);\n      }\n    });\n    this.clientesSvc.getClients().subscribe(clientes => this.clientes = clientes);\n    this.productsSvc.getProductos().subscribe(res => this.listProducts = res);\n    this.formNewSell = this.fb.group({\n      barcode: new FormControl('', [Validators.required, Validators.pattern(/^[0-9]+$/)]),\n      productQuantity: new FormControl('', [Validators.pattern(/^[0-9]+$/)]),\n      productQuantityBySearch: new FormControl(''),\n      coin: new FormControl(''),\n      date: new FormControl(''),\n      time: new FormControl(''),\n      discount: new FormControl('', [Validators.required, Validators.pattern(/^[0-9]+$/)])\n    });\n    this.tableSearch = new FormGroup({\n      search: new FormControl()\n    });\n  }\n  selectMoneda() {\n    this.coins.forEach(coin => {\n      if (coin.symbol === this.formNewSell.get('coin')?.value) {\n        this.coinSelected = coin;\n      }\n    });\n  }\n  verificarProductoAñadido(product) {\n    let exist = false;\n    this.products.forEach(producto => {\n      if (producto.name === product.name) {\n        exist = true;\n      } else {\n        exist = false;\n      }\n    });\n    return exist;\n  }\n  addQuantity(product) {\n    let values = {\n      icon: 'fa-regular fa-circle-xmark',\n      title: 'Ocurrió un error inesperado',\n      content: ''\n    };\n    if (this.verificarProductoAñadido(product)) {\n      values.content = 'Este producto ya se encuentra agregado a la venta';\n      this.changeModal(values);\n      this.popUp?.nativeElement.showModal();\n    } else if (product.exist_quantity === 0) {\n      values.content = 'No hay existencias de este producto para vender';\n      this.changeModal(values);\n      this.popUp?.nativeElement.showModal();\n    } else {\n      this.quantityProduct?.nativeElement.showModal();\n      this.product = product;\n    }\n  }\n  addProduct() {\n    let quantity;\n    if (this.formNewSell.get('productQuantity')?.value === '') {\n      quantity = 1;\n    } else {\n      quantity = this.formNewSell.get('productQuantity')?.value;\n    }\n    if (this.formNewSell.get('barcode')?.valid) {\n      this.productsSvc.getProductoByBarcode(this.formNewSell.get('barcode')?.value).subscribe(product => {\n        if (product instanceof Array) {\n          if (!this.verificarProductoAñadido(product[0])) {\n            this.sellProducts.push({\n              id_sell: 0,\n              id_product: product[0].id_product,\n              buy_price: 0,\n              sell_price: 0,\n              discount_product: 0,\n              impuest: 0,\n              quantity_products: quantity,\n              exist_products: 0,\n              quantity_back: 0\n            });\n            this.products.push(product[0]);\n          }\n        } else {\n          this.changeModal(product);\n          this.popUp?.nativeElement.showModal();\n          this.formNewSell.get('barcode')?.setValue('');\n          this.formNewSell.get('productQuantity')?.setValue('');\n        }\n      });\n    }\n  }\n  addProductBySearch(product) {\n    let quantity = this.formNewSell.get('productQuantityBySearch')?.value;\n    this.sellProducts.push({\n      id_sell: 0,\n      id_product: product.id_product,\n      buy_price: 0,\n      sell_price: 0,\n      discount_product: 0,\n      impuest: 0,\n      quantity_products: quantity,\n      exist_products: 0,\n      quantity_back: 0\n    });\n    this.products.push(product);\n    this.cancel(this.quantityProduct);\n    this.cancel(this.search);\n  }\n  acept(index) {\n    if (this.popUp?.nativeElement.children[1].textContent.includes('error')) {\n      this.popUp?.nativeElement.close();\n    } else if (this.popUp?.nativeElement.children[1].textContent.includes('¿Estás seguro?')) {\n      this.delete(index);\n      this.popUp?.nativeElement.close();\n    } else {\n      this.popUp?.nativeElement.close();\n    }\n  }\n  calcularSubtotal(product, index) {\n    return this.products[index].sell_price * this.sellProducts[index].quantity_products - this.products[index].sell_price * this.products[index].discount * this.sellProducts[index].quantity_products;\n  }\n  calcularTotal() {\n    let total = 0;\n    this.products.forEach((product, index) => {\n      total += this.products[index].sell_price * this.sellProducts[index].quantity_products - this.products[index].sell_price * this.products[index].discount * this.sellProducts[index].quantity_products;\n    });\n    return total;\n  }\n  calcularDescuentoVenta() {\n    return Number(this.formNewSell.get('discount')?.value) / 100 * this.calcularTotal();\n  }\n  calcularImpuestoVenta() {\n    let montoImponible = 0;\n    this.products.forEach((product, index) => {\n      if (product.impuest > 0) {\n        montoImponible += product.impuest * (product.sell_price * this.sellProducts[index].quantity_products - product.sell_price * product.discount * this.sellProducts[index].quantity_products);\n      }\n    });\n    return montoImponible;\n  }\n  total() {\n    return this.calcularTotal() + this.calcularImpuestoVenta() - this.calcularDescuentoVenta();\n  }\n  searchProduct() {\n    this.search?.nativeElement.showModal();\n  }\n  delete(index) {\n    this.products.splice(index, 1);\n    this.sellProducts.splice(index, 1);\n  }\n};\n__decorate([ViewChild('popup', {\n  static: true\n})], NuevaVentaComponent.prototype, \"popUp\", void 0);\n__decorate([ViewChild('searchProducts', {\n  static: true\n})], NuevaVentaComponent.prototype, \"search\", void 0);\n__decorate([ViewChild('quantity', {\n  static: true\n})], NuevaVentaComponent.prototype, \"quantityProduct\", void 0);\nNuevaVentaComponent = __decorate([Component({\n  selector: 'app-nueva-venta',\n  templateUrl: './nueva-venta.component.html',\n  styleUrls: ['./nueva-venta.component.css']\n})], NuevaVentaComponent);\nexport { NuevaVentaComponent };","map":{"version":3,"mappings":"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","names":["Component","ViewChild","FormControl","FormGroup","Validators","DinamicInput","NuevaVentaComponent","constructor","fb","routes","comunicatorSvc","productsSvc","coinsSvc","renderer","clientesSvc","Date","ngOnInit","title","ruta","setTimeout","url","slice","indexOf","push","decodeURI","toUpperCase","setTitleComponent","getCoins","subscribe","next","res","coins","forEach","coin","type","coinSelected","complete","formNewSell","get","setValue","symbol","getClients","clientes","getProductos","listProducts","group","barcode","required","pattern","productQuantity","productQuantityBySearch","date","time","discount","tableSearch","search","selectMoneda","value","verificarProductoAñadido","product","exist","products","producto","name","addQuantity","values","icon","content","changeModal","popUp","nativeElement","showModal","exist_quantity","quantityProduct","addProduct","quantity","valid","getProductoByBarcode","Array","sellProducts","id_sell","id_product","buy_price","sell_price","discount_product","impuest","quantity_products","exist_products","quantity_back","addProductBySearch","cancel","acept","index","children","textContent","includes","close","delete","calcularSubtotal","calcularTotal","total","calcularDescuentoVenta","Number","calcularImpuestoVenta","montoImponible","searchProduct","splice","__decorate","static","selector","templateUrl","styleUrls"],"sourceRoot":"","sources":["/home/luis/Documentos/systems vs code/inventary-system/client/src/app/content/ventas/nueva-venta/nueva-venta.component.ts"],"sourcesContent":["import { Component, ElementRef, Renderer2, ViewChild } from '@angular/core';\nimport { FormBuilder, FormControl, FormGroup, Validators } from '@angular/forms';\nimport { Router } from '@angular/router';\nimport { client, coin, product, register, sell, sell_product } from 'src/app/interfaces/interfaces';\nimport { ComunicatorComponetsService } from 'src/app/services/comunicator/comunicator-componets.service';\nimport { DinamicInput } from 'src/app/utils/DinamicInput';\nimport { ProductosService } from '../../productos/productos-en-almacen/service/productos.service';\nimport { CoinsService } from '../../configuraciones/service/coins.service';\nimport { ClientesService } from '../../administracion/clientes/service/clientes.service';\n\n@Component({\n  selector: 'app-nueva-venta',\n  templateUrl: './nueva-venta.component.html',\n  styleUrls: ['./nueva-venta.component.css']\n})\nexport class NuevaVentaComponent extends DinamicInput{\n  tableSearch!:FormGroup\n  formNewSell!: FormGroup;\n  products: product[] = []\n  date = new Date()\n  coins:coin[]=[]\n  clientes:client[]=[]\n  coinSelected!:coin\n  sell!:sell\n  sellProducts:sell_product[]=[]\n  listProducts:product[]=[]\n  product!:product\n  indexElementToDelete:number=0\n  @ViewChild('popup', { static: true }) override popUp?: ElementRef;\n  @ViewChild('searchProducts', { static: true }) search?: ElementRef;\n  @ViewChild('quantity', { static: true }) quantityProduct?: ElementRef;\n  constructor(private fb: FormBuilder, private routes: Router,\n     private comunicatorSvc: ComunicatorComponetsService,\n     private productsSvc: ProductosService,\n     private coinsSvc:CoinsService,\n     protected override renderer: Renderer2,\n     private clientesSvc:ClientesService) {\n    super();\n  }\n  ngOnInit() {\n    let title: string[] = [];\n    let ruta;\n    setTimeout(() => {\n      /* Obtengo la ruta actual y la transformo para obtener el titulo del componente*/\n      ruta = this.routes.url.slice((this.routes.url.slice(1).indexOf('/')) + 2);\n      title.push(decodeURI(ruta).toUpperCase());//añado el titulo al array\n      title.push(\"fas fa-cart-plus fa-fw\");//aañado el icono del titulo al array\n      this.comunicatorSvc.setTitleComponent(title);\n    });\n    this.coinsSvc.getCoins().subscribe({ \n      next: res => {\n      this.coins = res\n      res.forEach((coin: coin) => {\n        if (coin.type === 'principal')\n          this.coinSelected = coin\n      })\n    },\n    complete:()=>{\n      this.formNewSell.get('coin')?.setValue(this.coinSelected.symbol)\n    }})\n    this.clientesSvc.getClients().subscribe(clientes=>this.clientes=clientes)\n    this.productsSvc.getProductos().subscribe(res=>this.listProducts=res)\n    this.formNewSell = this.fb.group({\n        barcode: new FormControl('',[Validators.required, Validators.pattern(/^[0-9]+$/)]),\n        productQuantity: new FormControl('',[Validators.pattern(/^[0-9]+$/)]),\n        productQuantityBySearch:new FormControl(''),\n        coin:new FormControl(''),\n        date: new FormControl(''),\n        time: new FormControl(''),\n        discount:new FormControl('',[Validators.required, Validators.pattern(/^[0-9]+$/)]),\n      })\n      this.tableSearch = new FormGroup({\n        search: new FormControl(),\n      });\n  }\n  selectMoneda() {\n    this.coins.forEach((coin) => {\n      if (coin.symbol === this.formNewSell.get('coin')?.value) {\n        this.coinSelected = coin\n      }\n    })\n  }\n  verificarProductoAñadido(product: product) {\n    let exist: boolean = false\n    this.products.forEach((producto: product) => {\n      if (producto.name === product.name) {\n        exist = true\n      } else {\n        exist = false\n      }\n    })\n    return exist\n  }\n  addQuantity(product: product) {\n    let values = {\n      icon: 'fa-regular fa-circle-xmark',\n      title: 'Ocurrió un error inesperado',\n      content: ''\n    }\n    if (this.verificarProductoAñadido(product)) {\n      values.content='Este producto ya se encuentra agregado a la venta'\n      this.changeModal(values)\n      this.popUp?.nativeElement.showModal()\n    }else if(product.exist_quantity===0){\n      values.content='No hay existencias de este producto para vender'\n      this.changeModal(values)\n      this.popUp?.nativeElement.showModal()\n    } else {\n      this.quantityProduct?.nativeElement.showModal()\n     this.product = product\n    }\n  }\n\n  addProduct() {\n    let quantity: number\n    if (this.formNewSell.get('productQuantity')?.value === '') {\n      quantity = 1\n    } else {\n      quantity = this.formNewSell.get('productQuantity')?.value\n    }\n\n    if (this.formNewSell.get('barcode')?.valid) {\n      this.productsSvc.getProductoByBarcode(this.formNewSell.get('barcode')?.value).subscribe(\n        product => {\n          if (product instanceof Array) {\n\n            if (!this.verificarProductoAñadido(product[0])) {\n               this.sellProducts.push({\n                id_sell: 0, id_product: product[0].id_product,\n                buy_price: 0, sell_price: 0,discount_product:0,impuest:0, quantity_products: quantity,\n                exist_products: 0, quantity_back: 0\n              }) \n              this.products.push(product[0])\n            }\n          } else {\n            this.changeModal(product)\n            this.popUp?.nativeElement.showModal()\n            this.formNewSell.get('barcode')?.setValue('')\n            this.formNewSell.get('productQuantity')?.setValue('')\n          }\n        })\n    }\n  }\n  addProductBySearch(product: product) {\n    let quantity = this.formNewSell.get('productQuantityBySearch')?.value\n    this.sellProducts.push({\n      id_sell: 0, id_product: product.id_product,\n      buy_price: 0, sell_price: 0,discount_product:0,impuest:0, quantity_products: quantity,\n      exist_products: 0, quantity_back: 0\n    }) \n    this.products.push(product)\n    this.cancel(this.quantityProduct)\n    this.cancel(this.search)\n  }\n  acept(index: number) {\n    if (this.popUp?.nativeElement.children[1].textContent.includes('error')) {\n      this.popUp?.nativeElement.close()\n    } else if (this.popUp?.nativeElement.children[1].textContent.includes('¿Estás seguro?')) {\n      this.delete(index)\n      this.popUp?.nativeElement.close()\n    } else {\n      this.popUp?.nativeElement.close()\n    }\n  }\n  calcularSubtotal(product: product, index: number) {\n    return (this.products[index].sell_price * this.sellProducts[index].quantity_products)-\n    (this.products[index].sell_price * this.products[index].discount*this.sellProducts[index].quantity_products)\n  }\n\n  calcularTotal(){\n      let total = 0\n      this.products.forEach((product: product, index: number) => {\n        total += (this.products[index].sell_price * this.sellProducts[index].quantity_products)-\n        (this.products[index].sell_price * this.products[index].discount*this.sellProducts[index].quantity_products)\n      });\n      return total\n  }\n  calcularDescuentoVenta(){\n    return (Number(this.formNewSell.get('discount')?.value)/100)*this.calcularTotal()\n  }\n  calcularImpuestoVenta(){\n    let montoImponible=0\n    this.products.forEach((product:product,index: number)=>{\n      if(product.impuest>0){\n        montoImponible+=product.impuest*((product.sell_price * this.sellProducts[index].quantity_products)-\n        (product.sell_price * product.discount*this.sellProducts[index].quantity_products))\n      }\n    })\n    return montoImponible\n  }\n  total(){\n    return (this.calcularTotal()+this.calcularImpuestoVenta()-this.calcularDescuentoVenta())\n  }\n  searchProduct() {\n    this.search?.nativeElement.showModal();\n  }\n  delete(index: number) {\n    this.products.splice(index, 1)\n    this.sellProducts.splice(index, 1)\n  }\n\n}\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}